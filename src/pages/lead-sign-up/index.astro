---
export const prerender = false;

import { actions, isInputError } from "astro:actions";
import { Icon } from "astro-icon/components";
import MainLayout from "@/base/MainLayout.astro";
import { Button } from "@/components/starwind/button";
import { Checkbox } from "@/components/starwind/checkbox";
import { Input } from "@/components/starwind/input";
import { Select, SelectContent, SelectGroup, SelectItem, SelectTrigger, SelectValue } from "@/components/starwind/select";
import { Textarea } from "@/components/starwind/textarea";
import { siteMeta } from "@/lib/siteData";

const pageTitle: string = `Lead Sign Up | ${siteMeta.title}`;
const title: string = "Lead Sign Up";
const subTitle: string =
  "Have questions or want to discuss a project? We would be thrilled to help you build your next web project or revamp your current one. Fill out the contact form below to get started.";
const formTitle: string = "Fill out the form below";
const turnstileSiteKey = import.meta.env.TURNSTILE_PUBLIC_KEY;

// Handle redirect on successful form submission
const result = Astro.getActionResult(actions.sendLeadForm);
if (result && !result.error) {
  return Astro.redirect("/lead-sign-up/submission-received");
}

// Check for errors to display
let errorMessage: string | null = null;
if (result?.error) {
  if (isInputError(result.error)) {
    // For validation errors, extract all field-level error messages from Zod
    const fieldErrors = result.error.fields;
    const errorMessages: string[] = [];

    // Collect all field errors
    for (const [field, messages] of Object.entries(fieldErrors)) {
      if (messages && messages.length > 0) {
        // Join multiple errors for the same field with commas
        errorMessages.push(messages.join(", "));
      }
    }

    // Display all errors or a fallback message
    errorMessage = errorMessages.length > 0
      ? errorMessages.join(" â€¢ ")
      : "Please check your form for errors and try again.";
  } else {
    // For non-validation errors, display the error message
    errorMessage = result.error.message;
  }
}
---

<MainLayout
  title={pageTitle}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": "https://www.cobaltweb.tech/contact/",
    url: "https://www.cobaltweb.tech/contact/",
    name: "Lead Sign Up | Cobalt Web Technologies",
    description:
      "If you have questions or want to discuss your project needs please let us know. Cobalt Web Technologies is here to help you with all your website and web hosting needs.",
    isPartOf: {
      "@type": "WebSite",
      url: "https://www.cobaltweb.tech/",
      name: "Cobalt Web Technologies",
      description:
        "Cobalt Web Technologies builds high performance websites with secure managed cloud infrastructure along with digital marketing and SEO services.",
    },
    inLanguage: "en-US",
  }}
  enablePreconnect={true}
  preconnectUrl="https://challenges.cloudflare.com"
  externalScript={true}
  scriptUrl="https://challenges.cloudflare.com/turnstile/v0/api.js"
>
  <section class="mx-auto max-w-5xl">
    <div class="text-center">
      <h1
        class="text-2xl font-bold text-slate-800 md:text-4xl dark:text-slate-200"
      >
        {title}
      </h1>
      <p class="mt-1 text-pretty text-foreground">
        {subTitle}
      </p>
      <p class="mt-3 text-center text-foreground">
        If you are a current client and have technical or billing support
        questions, please use the <a
          href="/support/"
          class="text-cyan-500 hover:text-orange-600 dark:text-cyan-400 dark:hover:text-orange-400"
          >Support Form</a
        >.
      </p>
    </div>
  </section>

  <section class="mx-auto mt-12 w-full max-w-2xl">
    <div class="flex flex-col gap-4">
      <h2 class="text-xl font-bold text-foreground">
        {formTitle}
      </h2>
      <p class="text-foreground">Not all fields are required but to better assist you please fill out as much information as possible.</p>
      <!-- Contact Form (form data is handled via Astro Actions) -->
      <form
        id="lead-form"
        action={actions.sendLeadForm}
        method="POST"
        class="flex flex-col gap-4"
      >
        <div class="p-4 space-y-4 bg-card rounded-md">
        <div class="flex items-center gap-2">
          <Icon name="ListDetails" class="size-6 text-foreground" />
          <p class="font-semibold text-foreground">
            Basic Details
          </p>
        </div>
          <Select id="lead-type" name="leadtype" required>
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Select Entity Type" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Business">Business</SelectItem>
                <SelectItem value="Non-Profit">Non-Profit Organization</SelectItem>
                <SelectItem value="Self Employed">Self Employed</SelectItem>
                <SelectItem value="Govt/Public Entity">Government or Public Entity</SelectItem>
                <SelectItem value="Individual">Individual</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <Input
            id="entity-name"
            name="entityname"
            placeholder="Business or Entity Name"
          />
          <div class="flex gap-4">
            <Input
              id="firstname"
              name="firstname"
              placeholder="First Name"
              required
            />
            <Input
              id="lastname"
              name="lastname"
              placeholder="Last Name"
              required
            />
          </div>
          <Input
            id="email"
            placeholder="Email Address"
            name="email"
            type="email"
            required
          />
          <div class="flex gap-4">
            <Input
              id="phone"
              placeholder="Phone Number"
              name="phone"
              type="tel"
              required
            />
            <Input
              id="business-phone"
              placeholder="Business Phone Number"
              name="businessphone"
              type="tel"
            />
          </div>
        </div>

        <div class="p-4 space-y-4 bg-card rounded-md">
          <div class="flex items-center gap-2">
            <Icon name="www-globe" class="size-6 text-foreground" />
            <p class="font-semibold text-foreground">
              Current Website Info
            </p>
          </div>
          <p class="text-sm text-foreground">
            What type of web app do you have now or are you wanting to build? You may select multiple options.
          </p>
          <div class="flex flex-wrap gap-6">
            <Checkbox id="services" name="services" label="Services" size="lg" />
            <Checkbox id="blog" name="blog" label="Blog" size="lg" />
            <Checkbox id="ecommerce" name="ecommerce" label="E-commerce" size="lg" />
            <Checkbox id="content-creator" name="content-creator" label="Content Creator" size="lg" />
            <Checkbox id="personal" name="personal" label="Personal" size="lg" />
            <Checkbox id="political" name="political" label="Political" size="lg" />
            <Checkbox id="non-profit" name="non-profit" label="Non-Profit" size="lg" />
            <Checkbox id="subscription-membership" name="subscription-membership" label="Subscription or Membership" size="lg" />
            <Checkbox id="news-media" name="news-media" label="News Media" size="lg" />
            <Checkbox id="customer-portal" name="customer-portal" label="Customer Portal" size="lg" />
            <Checkbox id="general-business" name="general-business" label="General Business" size="lg" />
          </div>
          <Select id="has-website" name="haswebsite" required>
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Do you currently have a website" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Yes">Yes</SelectItem>
                <SelectItem value="No">No</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <p class="text-sm text-foreground">Enter the domain name of your current website or the domain name you wish to use for a new website. If you do not have a domain name enter a preferred name. Please note, domain registrations are subject to availability and we cannot guarantee a specific name.</p>
          <Input id="domain" name="domain" placeholder="Enter domain name (example.com)" required />
          <p class="text-sm text-foreground">
            If you currently have a domain registered who is the registrar? (e.g. GoDaddy, Namecheap, etc.). If you do not know please enter "unknown".
          </p>
          <Input id="domain-registrar" name="domain-registrar" placeholder="Enter name of domain registrar" />
          <p class="text-sm text-foreground">
            If you currently have a website who is the hosting provider? (e.g. Squarespace, Wix, GoDaddy, etc.) If you do not know please enter "unknown".
          </p>
          <Input id="current-host" name="current-host" placeholder="Enter name of hosting provider" />
        </div>

        <div class="p-4 space-y-4 bg-card rounded-md">
          <div class="flex items-center gap-2">
            <Icon name="Cloud" class="size-6 text-foreground" />
            <p class="font-semibold text-foreground">
              Infrastructure Needs
            </p>
          </div>
          <p class="text-sm text-foreground">
            How much average monthly web traffic do you currently have or anticipate to have? Select a range of monthly average active users. It's okay if you don't have the exact number we just need a rough estimate of your traffic requirements.
          </p>
          <Select id="estimated-traffic" name="estimatedtraffic">
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Select range of estimated monthly traffic" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Less than 1K">Less than 1K</SelectItem>
                <SelectItem value="1K - 10K">1K - 10K</SelectItem>
                <SelectItem value="10K - 50K">10K - 50K</SelectItem>
                <SelectItem value="50K - 100K">50K - 100K</SelectItem>
                <SelectItem value="100K - 500K">100K - 500K</SelectItem>
                <SelectItem value="More than 500K">More than 500K</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <p class="text-sm text-foreground">Will you need a database(s)? If you plan on storing any type of data such as transactional data, authentication system, logging, user input, persistent data store, etc. then you will require a database.
          </p>
          <Select id="database" name="database">
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Do you need a database?" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Yes">Yes</SelectItem>
                <SelectItem value="No">No</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <p class="text-sm text-foreground">Will you need object storage? This is for storing large amounts of unstructured data such as images, videos, documents, etc. If you plan on storing large amounts of data or users will be uploading data to your web applications then you will need object storage.
          </p>
          <Select id="object-storage" name="objectstorage">
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Do you need object storage?" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Yes">Yes</SelectItem>
                <SelectItem value="No">No</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <p class="text-sm text-foreground">
            Will you be requiring any third party integrations with your web apps? (e.g. CRM, marketing platform, analytics service, etc.)
          </p>
          <Select id="thridparty-integrations" name="thirdpartyintegrations">
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Do you need third party integrations?" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Yes">Yes</SelectItem>
                <SelectItem value="No">No</SelectItem>
                <SelectItem value="Unknown">Unknown</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
          <p class="text-sm text-foreground">
            If you do require any integration with a third party, list them below. Please note, any integration with a third party will require access to their API or infrastructure and is subject to the their terms of service. We cannot guarantee all third party integrations into a web app, but we will review any request and make a determination.
          </p>
          <Input id="integration-name" name="integration-name" placeholder="List all third party integrations" />
          <p class="text-sm text-foreground">
            Will you require payment processing in your web app?
          </p>
          <Select id="payment-processor" name="paymentprocessor">
            <SelectTrigger class="w-full">
              <SelectValue placeholder="Do you need a payment processor?" />
            </SelectTrigger>
            <SelectContent>
              <SelectGroup>
                <SelectItem value="Yes">Yes</SelectItem>
                <SelectItem value="No">No</SelectItem>
              </SelectGroup>
            </SelectContent>
          </Select>
       </div>

       <div class="p-4 space-y-4 bg-card rounded-md">
        <div class="flex items-center gap-2">
          <Icon name="Globe" class="size-6 text-foreground" />
          <p class="font-semibold text-foreground">
            Regulatory Compliance and International Requirements
          </p>
        </div>
        <p class="text-sm text-foreground">
          Will your app be subject to any regulatory compliance requirements in any national, regional, or local jurisdiction? If your business operates in jurisdictions that have specific web-based compliance requirements such as GDPR in the European Union or CCPA in the US State of California select yes. We will get more information from you later on the exact requirements you have.
        </p>
        <Select id="intl-require" name="intlrequire">
          <SelectTrigger class="w-full">
            <SelectValue placeholder="Do you have regulatory complicance requests?" />
          </SelectTrigger>
          <SelectContent>
            <SelectGroup>
              <SelectItem value="Yes">Yes</SelectItem>
              <SelectItem value="No">No</SelectItem>
              <SelectItem value="Unknown">Unknown</SelectItem>
            </SelectGroup>
          </SelectContent>
        </Select>
        <p class="text-sm text-foreground">
          If you have additional language requirements for internationalization list all languages. Please be aware we do not provide translation services, but we can set up the requirements for translating your app into other languages.
        </p>
        <Input id="languages" name="languages" placeholder="List all languages" />

       </div>

       <div class="p-4 space-y-4 bg-card rounded-md">
         <div class="flex items-center gap-2">
           <Icon name="PencilQuestion" class="size-6 text-foreground" />
           <p class="font-semibold text-foreground">
             Additional Information
           </p>
         </div>
        <Textarea
          id="message"
          placeholder="Please provide any additional information you may think we need. Also any questions you may have."
          name="message"
        />
       </div>

        <!-- Add Cloudflare Turnstile widget -->
        <!-- Remove cf-turnstile class to prevent auto-rendering -->
        <div
          id="turnstile-widget"
          class="mt-4"
          data-sitekey={turnstileSiteKey}
          data-theme="dark"
          data-size="flexible"
        >
        </div>
        <p class="text-xs text-slate-600 dark:text-slate-400">
          We're just checking that you're a real human filling out this form.
          <br />Bad bots stay away!
        </p>
        <!-- Render the error message if there is an error -->
        {
          errorMessage && (
            <div class="text-cobalt-50 rounded-lg border-2 border-orange-400 bg-orange-700 p-3 font-bold">
              <div class="flex justify-center gap-2">
                <Icon name="CloseFill" class="size-6 animate-bounce" />
                <span>{errorMessage}</span>
              </div>
            </div>
          )
        }
        <div class="mt-4">
          <Button type="submit" class="w-full" id="submit-button">
            <Icon name="Send" id="send-icon" />
            <Icon
              name="LoadingFill"
              id="loader-icon"
              class="hidden size-5 animate-spin"
            />
            <span id="button-text">Submit Request</span>
          </Button>
        </div>
      </form>
    </div>
  </section>
</MainLayout>
<!-- CF Turnstile import is handled by externalScript -->
<script>
  let turnstileWidgetId: string | null = null;
  let formSubmitHandler: ((e: Event) => void) | null = null;

  // Function to initialize Turnstile widget
  function initializeTurnstile() {
    const widget = document.getElementById("turnstile-widget");

    if (!widget || typeof turnstile === "undefined") {
      return;
    }

    // Remove existing widget if it exists
    if (turnstileWidgetId) {
      try {
        turnstile.remove(turnstileWidgetId);
        turnstileWidgetId = null;
      } catch (e) {
        console.warn("Failed to remove existing turnstile widget:", e);
      }
    }

    // Clear the widget container
    widget.innerHTML = "";

    // Render new widget
    try {
      const sitekey = widget.getAttribute("data-sitekey");
      const theme = widget.getAttribute("data-theme") as "light" | "dark" | "auto" | null;
      const size = widget.getAttribute("data-size") as "normal" | "compact" | "flexible" | null;

      const widgetId = turnstile.render("#turnstile-widget", {
        sitekey: sitekey || "",
        theme: theme || "dark",
        size: size || "flexible",
      });

      turnstileWidgetId = widgetId ?? null;
    } catch (e) {
      console.error("Failed to render turnstile widget:", e);
    }
  }

  // Setup form submission handler
  function setupFormHandler() {
    const form = document.getElementById("lead-form") as HTMLFormElement;
    const submitButton = document.getElementById(
      "submit-button",
    ) as HTMLButtonElement;
    const sendIcon = document.getElementById("send-icon") as HTMLElement;
    const loaderIcon = document.getElementById("loader-icon") as HTMLElement;
    const buttonText = document.getElementById("button-text") as HTMLSpanElement;

    if (!form) return;

    // Remove existing event listener if it exists
    if (formSubmitHandler) {
      form.removeEventListener("submit", formSubmitHandler);
    }

    // Toggle loading state
    const setLoading = (isLoading: boolean) => {
      if (!submitButton || !sendIcon || !loaderIcon || !buttonText) return;

      submitButton.disabled = isLoading;
      if (isLoading) {
        sendIcon.classList.add("hidden");
        loaderIcon.classList.remove("hidden");
        buttonText.textContent = "Submitting Request...";
      } else {
        sendIcon.classList.remove("hidden");
        loaderIcon.classList.add("hidden");
        buttonText.textContent = "Submit Request";
      }
    };

    // Create the handler function
    formSubmitHandler = (e: Event) => {
      // Client-side validation before submission
      const turnstileResponse = form.querySelector(
        'input[name="cf-turnstile-response"]'
      ) as HTMLInputElement;

      if (!turnstileResponse || !turnstileResponse.value) {
        e.preventDefault();
        alert("Please complete the CAPTCHA verification before submitting.");
        return;
      }

      // Validate email format
      const emailInput = form.querySelector(
        'input[name="email"]'
      ) as HTMLInputElement;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (emailInput && !emailRegex.test(emailInput.value)) {
        e.preventDefault();
        alert("Please enter a valid email address.");
        return;
      }

      // All validation passed, show loading state
      setLoading(true);
    };

    // Add the event listener
    form.addEventListener("submit", formSubmitHandler);
  }

  // Initialize Turnstile with polling for script availability
  function setupTurnstile() {
    if (typeof turnstile !== "undefined") {
      initializeTurnstile();
    } else {
      // Poll for turnstile to be available
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max
      const interval = setInterval(() => {
        attempts++;
        if (typeof turnstile !== "undefined") {
          clearInterval(interval);
          initializeTurnstile();
        } else if (attempts >= maxAttempts) {
          clearInterval(interval);
          console.error("Turnstile failed to load");
        }
      }, 100);
    }
  }

  // Initialize on first page load
  setupTurnstile();
  setupFormHandler();

  // Re-initialize on View Transitions
  document.addEventListener("astro:page-load", () => {
    setupTurnstile();
    setupFormHandler();
  });
</script>
