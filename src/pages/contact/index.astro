---

export const prerender = false;

import { actions, isInputError } from "astro:actions";
import { Icon } from "astro-icon/components";
import MainLayout from "@/base/MainLayout.astro";
import { Button } from "@/components/starwind/button";
import { Input } from "@/components/starwind/input";
import { Textarea } from "@/components/starwind/textarea";
import FormContactInfo from "@/components/ui/blocks/FormContactInfo.astro";
import { siteMeta } from "@/lib/siteData";

const pageTitle: string = `Contact | ${siteMeta.title}`;
const title: string = "Contact Us";
const subTitle: string =
  "Have questions or want to discuss a project? We would be thrilled to help you build your next web project or revamp your current one. Fill out the contact form below and our team will be in touch with you.";
const formTitle: string = "Fill out the form below";
const turnstileSiteKey = import.meta.env.TURNSTILE_PUBLIC_KEY;
// Handle redirect on successful form submission
const result = Astro.getActionResult(actions.sendContactForm);
if (result && !result.error) {
  return Astro.redirect("/contact/submission-received");
}
// Check for errors to display
let errorMessage: string | null = null;
if (result?.error) {
  if (isInputError(result.error)) {
    // For validation errors, extract all field-level error messages from Zod
    const fieldErrors = result.error.fields;
    const errorMessages: string[] = [];
    
    // Collect all field errors
    for (const [field, messages] of Object.entries(fieldErrors)) {
      if (messages && messages.length > 0) {
        // Join multiple errors for the same field with commas
        errorMessages.push(messages.join(", "));
      }
    }
    
    // Display all errors or a fallback message
    errorMessage = errorMessages.length > 0 
      ? errorMessages.join(" â€¢ ") 
      : "Please check your form for errors and try again.";
  } else {
    // For non-validation errors, display the error message
    errorMessage = result.error.message;
  }
}
---

<MainLayout
  title={pageTitle}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "@id": "https://www.cobaltweb.tech/contact/",
    url: "https://www.cobaltweb.tech/contact/",
    name: "Contact | Cobalt Web Technologies",
    description:
      "If you have questions or want to discuss your project needs please let us know. Cobalt Web Technologies is here to help you with all your website and web hosting needs.",
    isPartOf: {
      "@type": "WebSite",
      url: "https://www.cobaltweb.tech/",
      name: "Cobalt Web Technologies",
      description:
        "Cobalt Web Technologies builds high performance websites with secure managed cloud infrastructure along with digital marketing and SEO services.",
    },
    inLanguage: "en-US",
  }}
  externalScript={true}
  scriptUrl="https://challenges.cloudflare.com/turnstile/v0/api.js"
>
  <section class="mx-auto max-w-5xl">
    <div class="text-center">
      <h1
        class="text-2xl font-bold text-slate-800 md:text-4xl dark:text-slate-200"
      >
        {title}
      </h1>
      <p class="mt-1 text-pretty text-slate-700 dark:text-slate-300">
        {subTitle}
      </p>
      <p class="mt-3 text-center text-slate-700 dark:text-slate-300">
        If you are a current client and have technical or billing support
        questions, please use the <a
          href="/support/"
          class="text-cyan-500 hover:text-orange-600 dark:text-cyan-400 dark:hover:text-orange-400"
          >Support Form</a
        >.
      </p>
    </div>
  </section>

  <section class="mx-auto mt-12 grid max-w-5xl gap-4 md:grid-cols-2 md:gap-8">
    <div class="flex flex-col gap-4">
      <h2 class="mb-4 text-xl font-bold text-slate-700 dark:text-slate-300">
        {formTitle}
      </h2>
      <!-- Contact Form (form data is sent via Astro Actions) -->
      <form
        id="contact-form"
        action={actions.sendContactForm}
        method="POST"
        class="flex flex-col gap-4"
      >
        <div class="flex flex-row gap-4">
          <Input
            id="firstname"
            name="firstname"
            placeholder="First Name"
            required
          />
          <Input
            id="lastname"
            name="lastname"
            placeholder="Last Name"
            required
          />
        </div>
        <Input
          id="email"
          placeholder="Email Address"
          name="email"
          type="email"
          required
        />
        <Input
          id="phone"
          placeholder="Phone Number"
          name="phone"
          type="tel"
          required
        />
        <Textarea
          id="message"
          placeholder="Please provide any questions or comments"
          name="message"
          required
        />
        <!-- Add Cloudflare Turnstile widget -->
        <!-- Remove cf-turnstile class to prevent auto-rendering -->
        <div
          id="turnstile-widget"
          class="mt-4"
          data-sitekey={turnstileSiteKey}
          data-theme="dark"
          data-size="flexible"
        >
        </div>
        <p class="text-xs text-slate-600 dark:text-slate-400">
          We're just checking that you're a real human filling out this form.
          <br />Bad bots stay away!
        </p>
        <!-- Render the error message if there is an error -->
        {
          errorMessage && (
            <div class="text-cobalt-50 rounded-lg border-2 border-orange-400 bg-orange-700 p-3 font-bold">
              <div class="flex justify-center gap-2">
                <>
                  <Icon name="CloseFill" class="size-6 animate-bounce" />
                  <span>{errorMessage}</span>
                </>
              </div>
            </div>
          )
        }
        <div class="mt-4">
          <Button type="submit" class="w-full" id="submit-button">
            <Icon name="Send" id="send-icon" />
            <Icon
              name="LoadingFill"
              id="loader-icon"
              class="hidden size-5 animate-spin"
            />
            <span id="button-text">Send Contact Request</span>
          </Button>
        </div>
      </form>
    </div>
    <!-- Second column with contact info -->
    <FormContactInfo
      phoneUrl="tel:+15122941600"
      phoneNumber="+1-512-294-1600"
      emailUrl="mailto:info@cobaltweb.tech"
      emailAddress="info@cobaltweb.tech"
    />
  </section>
</MainLayout>
<!-- CF Turnstile import is handled by externalScript -->
<script>
  let turnstileWidgetId: string | null = null;
  let formSubmitHandler: ((e: Event) => void) | null = null;

  // Function to initialize Turnstile widget
  function initializeTurnstile() {
    const widget = document.getElementById("turnstile-widget");
    
    if (!widget || typeof turnstile === "undefined") {
      return;
    }

    // Remove existing widget if it exists
    if (turnstileWidgetId) {
      try {
        turnstile.remove(turnstileWidgetId);
        turnstileWidgetId = null;
      } catch (e) {
        console.warn("Failed to remove existing turnstile widget:", e);
      }
    }

    // Clear the widget container
    widget.innerHTML = "";

    // Render new widget
    try {
      const sitekey = widget.getAttribute("data-sitekey");
      const theme = widget.getAttribute("data-theme") as "light" | "dark" | "auto" | null;
      const size = widget.getAttribute("data-size") as "normal" | "compact" | "flexible" | null;
      
      const widgetId = turnstile.render("#turnstile-widget", {
        sitekey: sitekey || "",
        theme: theme || "dark",
        size: size || "flexible",
      });
      
      turnstileWidgetId = widgetId ?? null;
    } catch (e) {
      console.error("Failed to render turnstile widget:", e);
    }
  }

  // Setup form submission handler
  function setupFormHandler() {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const submitButton = document.getElementById(
      "submit-button",
    ) as HTMLButtonElement;
    const sendIcon = document.getElementById("send-icon") as HTMLElement;
    const loaderIcon = document.getElementById("loader-icon") as HTMLElement;
    const buttonText = document.getElementById("button-text") as HTMLSpanElement;

    if (!form) return;

    // Remove existing event listener if it exists
    if (formSubmitHandler) {
      form.removeEventListener("submit", formSubmitHandler);
    }

    // Toggle loading state
    const setLoading = (isLoading: boolean) => {
      if (!submitButton || !sendIcon || !loaderIcon || !buttonText) return;
      
      submitButton.disabled = isLoading;
      if (isLoading) {
        sendIcon.classList.add("hidden");
        loaderIcon.classList.remove("hidden");
        buttonText.textContent = "Submitting Request...";
      } else {
        sendIcon.classList.remove("hidden");
        loaderIcon.classList.add("hidden");
        buttonText.textContent = "Send Contact Request";
      }
    };

    // Create the handler function
    formSubmitHandler = (e: Event) => {
      // Client-side validation before submission
      const turnstileResponse = form.querySelector(
        'input[name="cf-turnstile-response"]'
      ) as HTMLInputElement;

      if (!turnstileResponse || !turnstileResponse.value) {
        e.preventDefault();
        alert("Please complete the CAPTCHA verification before submitting.");
        return;
      }

      // Validate email format
      const emailInput = form.querySelector(
        'input[name="email"]'
      ) as HTMLInputElement;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (emailInput && !emailRegex.test(emailInput.value)) {
        e.preventDefault();
        alert("Please enter a valid email address.");
        return;
      }

      // All validation passed, show loading state
      setLoading(true);
    };

    // Add the event listener
    form.addEventListener("submit", formSubmitHandler);
  }

  // Initialize Turnstile with polling for script availability
  function setupTurnstile() {
    if (typeof turnstile !== "undefined") {
      initializeTurnstile();
    } else {
      // Poll for turnstile to be available
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max
      const interval = setInterval(() => {
        attempts++;
        if (typeof turnstile !== "undefined") {
          clearInterval(interval);
          initializeTurnstile();
        } else if (attempts >= maxAttempts) {
          clearInterval(interval);
          console.error("Turnstile failed to load");
        }
      }, 100);
    }
  }

  // Initialize on first page load
  setupTurnstile();
  setupFormHandler();

  // Re-initialize on View Transitions
  document.addEventListener("astro:page-load", () => {
    setupTurnstile();
    setupFormHandler();
  });
</script>
